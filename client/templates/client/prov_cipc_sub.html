{% extends 'base.html' %}
{% load static %}

{% block title %} 
    {{return_caption}}
{% endblock title %}

{% block exportblock %}
    <a href="?{{ request.GET.urlencode }}&export=csv" 
    class="btn btn-success btn-sm">
        <i class="fas fa-download"></i> Export to CSV
    </a>
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">

<div id="ajax-urls"
     data-update-cipcprov-url="{% url 'update-cipc-prov' %}">
</div>
    {% if user.is_authenticated %}
        <h6 class="h6 mt-4">{{return_caption}}</h6>     
        <form method="get" class="mt-2 mb-4">
            <div class="row g-3 mt-2">
                <div class="form-group col-md-4 mt-2">
                    {{ form.client_type.label_tag }}  
                    {{ form.client_type }} 
                </div>
                <div class="form-group col-md-4 mt-2">
                    {{ form.month.label_tag }}  
                    {{ form.month }}  
                </div>
                <div class="form-group col-md-4 mt-2">
                    {{ form.accountant.label_tag }}  
                    {{ form.accountant }} 
                </div>
             </div>
            <div class="row g-3 mt-2">
                <div class="form-group col-md-4 mt-2">
                    {{ form.years.label_tag }}  
                    {{ form.years }}  
                </div>

                    <div class="form-group col-md-4 mt-2">
                        {{ form.return_type.label_tag }}  
                        {{ form.return_type }}   
                    </div>
                    <div class="form-group col-md-4 mt-2">
                        {{ form.searchterm.label_tag }}  
                        {{ form.searchterm }} 
                    </div>
            </div>
            <div class="row g-3 mt-2">
                <button id="id_submit_btn" type="submit" class="btn btn-outline-primary w-100">Submit</button>
            </div>
            </form>
    {% if clients %}
    <h6 class="h6 mt-4" id="filtered-row-count">Total found: {{count}}</h6>
    <table class="table table-striped table-hover table-bordered">
    {% include "client/_table_headers.html" with headers=headers %}
    <thead>

        <tr class="summary-row">
            <td></td>
            <td></td>
            <td></td>
            <td>
                <select id="cipcprov-filter" class="form-select form-select-sm">
                    <option value="all">All</option>
                    <option value="completed">Completed</option>
                    <option value="incomplete">Incomplete</option>
                </select>
            </td>
            <td></td>
            <td>
                <select id="invoicing-filter" class="form-select form-select-sm">
                    <option value="all">All</option>
                    <option value="invoiced">Invoiced</option>
                    <option value="pending">Pending</option>
                </select>
            </td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </thead>
    <tbody>

        {% for record in clients %}
            <tr data-row-id="{{ record.id }}" data-return-type="{{return_type}}">
                <td><a href="{% url 'client-detail' record.client.id %}" class="text-decoration-none">{{ record.client.get_client_full_name }}</a></td>
                <td>{{ record.financial_year }}</td>
                <td>{{ month }}</td>
                <td> <button {% if record.finish_date %} class="btn btn-success" {% else %}class="btn btn-warning" {% endif %}>{% if record.finish_date %} Completed {% else %}Incomplete {% endif %}</button></td>
                
                {% if return_type == "cipc" %}
                    <td> <input name="finish_date" type="date" value="{{ record.finish_date|date:'Y-m-d' }}" class="form-control" {% if not perms.client.change_return_date %} disabled {% endif %}> </td>
                {% else %}
                     <td> <input name="finish_date" type="date" value="{{ record.finish_date|date:'Y-m-d' }}" class="form-control" {% if not perms.client.change_irp_date %} disabled {% endif %}> </td>                   
                {% endif %}
                
                <td> <button {% if record.invoice_date %} class="btn btn-success" {% else %}class="btn btn-warning" {% endif %}>{% if record.invoice_date %} Invoiced {% else %}Pending {% endif %}</button></td>
                
               
                <td> <input name="invoice_date" type="date" value="{{ record.invoice_date|date:'Y-m-d' }}" class="form-control" {% if not perms.client.change_invoice_date %} disabled {% endif %}> </td>
                

                <td> <textarea class="form-control" >{{ record.comment|default_if_none:"" }}</textarea></td>
                
                <td>     
                    <div class="dropdown"> 
                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                Actions
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ forloop.counter }}">
                            <li><a class="dropdown-item save-action" href="#" data-client="{{ record.client.id }}">Save</a></li>
                        
                            <li {% if not perms.client.change_return_date or not perms.client.change_irp_date or not perms.client.change_invoice_date %} disabled {% endif %}><a class="dropdown-item clear-action" href="#" data-client="{{ record.client.id }}">Clear</a></li>

                        </ul>
                        <span class="save-message text-success small ms-2" style="display: none;">Saved!</span>
                    </div> 
                </td>
            </tr>
        {% endfor %}
    </tbody>
    </table>
    {% endif %}        
    {% endif %}
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/searchClient.js' %}"></script>
<script src="{% static 'js/updateCipcProv.js' %}"></script>
{% endblock extra_js %}